<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∏ Band Practice</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Firebase Auth Gate -->
    <div id="auth-gate" style="display: none;">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; max-width: 400px;">
                <h1 style="margin-bottom: 30px; color: #333; font-size: 28px; font-weight: 700;">üé∏ Band Practice Pro</h1>
                <p style="color: #666; margin-bottom: 30px;">Sign in with your Google account to continue</p>
                <div id="firebaseui-auth-container"></div>
                <div id="auth-error" style="color: #c33; margin-top: 20px; display: none;"></div>
                <p style="font-size: 10px; color: #aaa; margin-top: 20px; margin-bottom: 0;">Thanks to <a href="https://getsongbpm.com" target="_blank" style="color: #bbb; text-decoration: none;">getsongbpm.com</a> for BPM data.</p>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" style="display: none;">
        <header>
            <div class="header-single-row">
                <h1>üé∏ Band Practice</h1>
                <div class="song-selector">
                    <button id="import-playlist-btn" class="btn btn-primary" title="Import songs from Spotify playlist">
                        <span class="icon">üì•</span> Playlist...
                    </button>
                    <button id="open-song-selector-btn" class="btn btn-primary" title="Open song selector (Ctrl+O)">
                        <span class="icon">üéµ</span> Song...
                    </button>
                    <span id="current-song-display" class="current-song-display">No song selected</span>
                </div>
                <div class="status-bar">
                    <span id="status-message" class="status-message"></span>
                </div>
                <div class="font-size-selector">
                    <label for="font-size-select" style="font-size: 10px; color: var(--text-secondary);">Font:</label>
                    <select id="font-size-select" class="font-size-select">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                        <option value="xlarge">X-Large</option>
                    </select>
                </div>
                <div class="user-info">
                    <span id="user-email" class="user-email">Loading...</span>
                    <button id="signout-btn" class="btn btn-small btn-secondary">Sign Out</button>
                </div>
            </div>
        </header>

        <main class="container">
            <div class="panels">
                <!-- Lyrics Panel -->
                <div class="panel lyrics-panel" id="lyrics-panel">
                    <div class="panel-header">
                        <div class="lyrics-header-left">
                            <h2 id="lyrics-heading">Lyrics</h2>
                            <div class="song-metadata" id="song-metadata"></div>
                        </div>
                        <div class="lyrics-header-actions">
                            <button id="toggle-columns-btn" class="btn btn-small btn-secondary" title="Toggle between 1 and 2 column layout">
                                <span class="icon">‚öô</span> 1 Col
                            </button>
                            <button id="fetch-bpm-btn" class="btn btn-small btn-secondary" disabled title="Fetch BPM for current song">
                                <span class="icon">üéµ</span> Fetch BPM
                            </button>
                            <button id="edit-lyrics-btn" class="btn btn-small btn-secondary" disabled title="Edit lyrics for current song">
                                <span class="icon">‚úèÔ∏è</span> Edit
                            </button>
                            <button id="refresh-song-btn" class="btn btn-small btn-secondary" disabled title="Refresh lyrics for current song">
                                <span class="icon">‚ôªÔ∏è</span> Refresh
                            </button>
                            <button id="delete-song-btn" class="btn btn-small btn-secondary" disabled title="Delete current song from database" style="background-color: #c33;">
                                <span class="icon">üóëÔ∏è</span> Delete
                            </button>
                        </div>
                    </div>
                    <div class="panel-content" id="lyrics-content">
                        <div id="lyrics-content-inner" class="lyrics-columns-1">
                            <div class="empty-state">
                                <p>Select a song to view lyrics</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resize Handle -->
                <div class="resize-handle" id="resize-handle"></div>

                <!-- Notes Panel -->
                <div class="panel notes-panel" id="notes-panel">
                    <div class="panel-header">
                        <h2>Practice Notes</h2>
                        <div class="notes-actions">
                            <button id="edit-notes-btn" class="btn btn-small btn-secondary" disabled>
                                <span class="icon">‚úèÔ∏è</span> Edit
                            </button>
                            <button id="save-notes-btn" class="btn btn-small btn-primary" style="display: none;">
                                <span class="icon">üíæ</span> Save
                            </button>
                            <button id="cancel-edit-btn" class="btn btn-small btn-secondary" style="display: none;">
                                Cancel
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <!-- View Mode -->
                        <div id="notes-view" class="notes-view">
                            <div class="empty-state">
                                <p>Select a song to view notes</p>
                            </div>
                        </div>
                        <!-- Edit Mode -->
                        <div id="notes-edit" class="notes-edit" style="display: none;">
                            <div class="edit-help">
                                <strong>Note Syntax:</strong>
                                <code>12: Your note here</code> or
                                <code>45-48: Your note here</code>
                                <br><small style="color: var(--text-muted);">(Optional: <code>Line 12:</code> or <code>Lines 45-48:</code>)</small>
                            </div>
                            <textarea id="notes-textarea" class="notes-textarea" placeholder="Add your practice notes here...

Example:
12: Heavy kick on 1 and 3
45-48: Double time, watch for break

Or with Line/Lines:
Line 71: thend"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Import Playlist Dialog -->
        <div id="import-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-large">
                <div class="dialog-header">
                    <h3>Import Spotify Playlist</h3>
                    <button id="import-dialog-close" class="btn btn-small btn-secondary">‚úï</button>
                </div>

                <!-- Step 1: Enter URL -->
                <div id="import-step-url" class="import-step">
                    <div class="import-url-section">
                        <label for="import-playlist-url">Spotify Playlist URL:</label>
                        <input type="text" id="import-playlist-url" class="input"
                               placeholder="https://open.spotify.com/playlist/YOUR_PLAYLIST_ID">
                        <button id="import-load-btn" class="btn btn-primary">Load Playlist</button>
                    </div>
                </div>

                <!-- Step 2: Select Songs -->
                <div id="import-step-select" class="import-step" style="display: none;">
                    <div class="import-playlist-info">
                        <div id="import-playlist-details"></div>
                        <div class="import-selection-controls">
                            <button id="import-select-all-btn" class="btn btn-small btn-secondary">Select All</button>
                            <button id="import-select-none-btn" class="btn btn-small btn-secondary">Select None</button>
                            <span id="import-selection-count" class="selection-count">0 songs selected</span>
                        </div>
                    </div>
                    <div id="import-songs-list" class="import-songs-list"></div>
                    <div class="dialog-actions">
                        <button id="import-back-btn" class="btn btn-secondary">Back</button>
                        <button id="import-start-btn" class="btn btn-primary" disabled>Import Selected Songs</button>
                    </div>
                </div>

                <!-- Step 3: Import Progress -->
                <div id="import-step-progress" class="import-step" style="display: none;">
                    <div class="import-progress-header">
                        <h4>Importing Songs...</h4>
                        <div id="import-overall-progress">
                            <div class="progress-bar">
                                <div id="import-progress-fill" class="progress-fill"></div>
                            </div>
                            <div id="import-progress-text">0 / 0</div>
                        </div>
                    </div>
                    <div id="import-progress-list" class="import-progress-list"></div>
                    <div class="dialog-actions">
                        <button id="import-done-btn" class="btn btn-primary" style="display: none;">Done</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lyrics Editor Dialog -->
        <div id="lyrics-editor-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-large">
                <div class="dialog-header">
                    <h3 id="lyrics-editor-title">Edit Lyrics</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="tighten-lyrics-btn" class="btn btn-small btn-secondary" title="Remove blank lines after section headers">
                            <span class="icon">üìê</span> Tighten
                        </button>
                        <div class="customization-badge" id="customization-badge" style="display: none;">
                            <span style="color: #FF9800;">‚ö†Ô∏è Customized</span>
                        </div>
                    </div>
                </div>
                <div class="lyrics-editor-content">
                    <div class="lyrics-editor-left">
                        <div class="lyrics-editor-wrapper">
                            <div id="lyrics-editor-line-numbers" class="lyrics-editor-line-numbers"></div>
                            <textarea id="lyrics-editor-textarea" class="lyrics-editor-textarea"
                                      placeholder="Enter lyrics here..."></textarea>
                        </div>
                    </div>
                    <div class="lyrics-editor-right">
                        <div class="lyrics-editor-notes-header">
                            <h4>Practice Notes</h4>
                        </div>
                        <div id="lyrics-editor-notes" class="lyrics-editor-notes">
                            <div class="empty-state">
                                <p>No notes for this song</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dialog-actions">
                    <button id="lyrics-editor-cancel-btn" class="btn btn-secondary">Cancel</button>
                    <button id="lyrics-editor-save-btn" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Song Selector Dialog -->
        <div id="song-selector-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-medium">
                <div class="dialog-header">
                    <h3>Select Song</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="song-count-display" class="song-count-display">0 songs</span>
                        <button id="toggle-sort-btn" class="btn btn-small btn-secondary" title="Toggle sort by Artist (Ctrl+T)">
                            <span class="icon">üîÑ</span> Sort: <span id="sort-mode">Song</span>
                        </button>
                        <button id="song-selector-close" class="btn btn-small btn-secondary">‚úï</button>
                    </div>
                </div>
                <div class="song-selector-search">
                    <input type="text" id="song-search-input" class="song-search-input" placeholder="Type to filter songs..." autocomplete="off">
                </div>
                <div id="song-selector-list" class="song-selector-list">
                    <div class="empty-state"><p>Loading songs...</p></div>
                </div>
            </div>
        </div>

        <!-- Confirmation Dialog -->
        <div id="confirm-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3 id="confirm-dialog-title">Confirm Action</h3>
                <p id="confirm-dialog-message"></p>
                <div class="dialog-actions">
                    <button id="confirm-dialog-cancel-btn" class="btn btn-secondary">Cancel</button>
                    <button id="confirm-dialog-confirm-btn" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p id="loading-message">Loading...</p>
            <div id="loading-details" style="display: none; margin-top: 20px; text-align: center; max-width: 400px;">
                <div id="playlist-info" style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;"></div>
                <div id="sync-progress" style="font-size: 14px; color: #aaa;"></div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="toast-container"></div>

        <!-- Back to Top Button -->
        <button id="back-to-top-btn" class="back-to-top-btn" title="Back to top">‚Üë</button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />

    <script>
        // Check if we're in development mode
        const isDevelopmentMode = {{ 'true' if config.get('FLASK_ENV') == 'development' else 'false' }};

        if (isDevelopmentMode) {
            console.log('üîß DEVELOPMENT MODE - Bypassing Firebase Auth');
            // Skip all Firebase auth, show main app immediately
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-email').textContent = 'dev@localhost.com (Dev Mode)';

            // Mock apiCall function for development
            window.apiCall = async function(url, options = {}) {
                return fetch(url, options);
            };

            // Initialize the main app
            if (window.initializeApp) {
                window.initializeApp(window.apiCall);
            }
        } else {
            // Production mode - use Firebase Auth
            console.log('üî• PRODUCTION MODE - Using Firebase Auth');

        // Firebase configuration - replace with your project's config
        const firebaseConfig = {
            apiKey: "{{ config.FIREBASE_API_KEY }}",
            authDomain: "{{ config.FIREBASE_AUTH_DOMAIN }}",
            projectId: "{{ config.FIREBASE_PROJECT_ID }}"
        };

        console.log('üî• Firebase config:', firebaseConfig);
        console.log('üî• Step 1: Initializing Firebase...');

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        console.log('üî• Step 2: Firebase initialized');

        const auth = firebase.auth();
        console.log('üî• Step 3: Auth instance created');

        // Set persistence to LOCAL for redirect flow
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
            console.log('üî• Step 4: Persistence set to LOCAL');
        }).catch((error) => {
            console.error('‚ùå Failed to set persistence:', error);
        });

        // FirebaseUI configuration
        const uiConfig = {
            signInFlow: 'popup',  // Use popup flow (works reliably on localhost)
            signInOptions: [
                {
                    provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                    customParameters: {
                        prompt: 'select_account'
                    }
                }
            ],
            callbacks: {
                signInSuccessWithAuthResult: (authResult) => {
                    console.log('‚úÖ‚úÖ‚úÖ SIGN IN SUCCESS CALLBACK FIRED ‚úÖ‚úÖ‚úÖ');
                    console.log('üìß User email:', authResult.user.email);
                    console.log('üÜî User uid:', authResult.user.uid);
                    console.log('‚úÖ Email verified:', authResult.user.emailVerified);
                    console.log('üë§ Full user object:', authResult.user);
                    console.log('üîê Credential:', authResult.credential);
                    console.log('üìù Additional user info:', authResult.additionalUserInfo);
                    console.log('üîÑ Auth successful - onAuthStateChanged will handle UI');
                    // Return false - let onAuthStateChanged handle showing the app
                    return false;
                },
                signInFailure: (error) => {
                    console.error('‚ùå‚ùå‚ùå SIGN IN FAILURE ‚ùå‚ùå‚ùå');
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    console.error('Full error:', error);
                    return Promise.resolve();
                },
                uiShown: () => {
                    console.log('üé® FirebaseUI widget shown');
                }
            }
        };

        console.log('üî• Step 5: Creating FirebaseUI instance...');
        const ui = new firebaseui.auth.AuthUI(auth);
        console.log('üî• Step 6: FirebaseUI created');

        let currentUser = null;
        let idToken = null;
        let authStateCallCount = 0;

        // Auth state observer
        console.log('üî• Step 7: Setting up onAuthStateChanged listener...');
        auth.onAuthStateChanged(async (user) => {
            authStateCallCount++;
            console.log('üîêüîêüîê AUTH STATE CHANGED CALLBACK FIRED (Call #' + authStateCallCount + ') üîêüîêüîê');
            console.log('üìç Current URL:', window.location.href);
            console.log('üìç Has URL params?', window.location.search);
            console.log('User object:', user);
            console.log('User email:', user ? user.email : 'NULL');
            console.log('User emailVerified:', user ? user.emailVerified : 'N/A');
            console.log('User uid:', user ? user.uid : 'N/A');

            // DEBUG: Check if user was signed in before
            if (!user && currentUser) {
                console.error('üö®üö®üö® USER WAS SIGNED IN BUT NOW IS NULL üö®üö®üö®');
                console.error('Previous user:', currentUser.email);
                console.error('This means Firebase signed the user out!');
            }

            if (user) {
                // User is signed in
                console.log('‚úÖ USER IS SIGNED IN');
                try {
                    console.log('üìù Step A: Getting ID token...');
                    idToken = await user.getIdToken();
                    console.log('‚úÖ Step B: Got ID token (first 50 chars):', idToken.substring(0, 50));
                    currentUser = user;

                    // Check if user is allowed by making a test API call
                    console.log('üåê Step C: About to call /api/user with Authorization header...');
                    console.log('Authorization header will be:', `Bearer ${idToken.substring(0, 50)}...`);

                    const response = await fetch('/api/user', {
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });

                    console.log('üì• Step D: /api/user response received. Status:', response.status);

                    if (response.ok) {
                        // User is authorized
                        console.log('‚úÖ‚úÖ‚úÖ USER AUTHORIZED ‚úÖ‚úÖ‚úÖ');
                        console.log('User email:', user.email);
                        console.log('Step E: Hiding auth gate, showing main app');
                        document.getElementById('auth-gate').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        document.getElementById('user-email').textContent = user.email;

                        console.log('Step F: Checking if window.initializeApp exists:', typeof window.initializeApp);
                        // Initialize the main app with authenticated API calls
                        if (window.initializeApp) {
                            console.log('Step G: Calling window.initializeApp...');
                            window.initializeApp(apiCall);
                            console.log('Step H: window.initializeApp completed');
                        } else {
                            console.error('‚ùå window.initializeApp is not defined!');
                        }
                    } else {
                        // User not authorized
                        const errorText = await response.text();
                        console.error('‚ùå‚ùå‚ùå AUTHORIZATION FAILED ‚ùå‚ùå‚ùå');
                        console.error('Response status:', response.status);
                        console.error('Response body:', errorText);
                        console.error('User email:', user.email);
                        console.error('ID token (first 50 chars):', idToken.substring(0, 50));
                        document.getElementById('auth-error').textContent =
                            'You are not authorized to access this application. Contact the admin.';
                        document.getElementById('auth-error').style.display = 'block';
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error('üí•üí•üí• ERROR DURING AUTHENTICATION üí•üí•üí•');
                    console.error('Error:', error);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    document.getElementById('auth-error').textContent = 'Authentication error. Please try again.';
                    document.getElementById('auth-error').style.display = 'block';
                }
            } else {
                // User is signed out
                console.log('üëãüëãüëã USER IS NULL - SIGNED OUT üëãüëãüëã');
                console.log('üîç Checking localStorage for auth data...');
                console.log('localStorage keys:', Object.keys(localStorage));
                console.log('firebase:authUser keys:', Object.keys(localStorage).filter(k => k.includes('firebase')));

                // Check if we're returning from OAuth redirect
                const urlParams = new URLSearchParams(window.location.search);
                console.log('üîç URL params:', Array.from(urlParams.entries()));

                console.log('Step X: Hiding main app, showing auth gate');
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('auth-gate').style.display = 'block';

                // Check if FirebaseUI is already rendered
                const authContainer = document.getElementById('firebaseui-auth-container');
                console.log('üîç Auth container children:', authContainer.children.length);

                if (authContainer.children.length === 0) {
                    console.log('Step Y: Starting FirebaseUI...');
                    ui.start('#firebaseui-auth-container', uiConfig);
                    console.log('Step Z: FirebaseUI started');
                } else {
                    console.log('‚ö†Ô∏è FirebaseUI already rendered, not starting again');
                }
            }
        });

        console.log('üî• Step 8: onAuthStateChanged listener registered');

        // Sign out handler
        document.getElementById('signout-btn')?.addEventListener('click', () => {
            auth.signOut();
        });

        // Helper function to make authenticated API calls
        async function apiCall(url, options = {}) {
            if (!idToken) {
                idToken = await currentUser.getIdToken(true);
            }

            const headers = {
                'Authorization': `Bearer ${idToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            return fetch(url, { ...options, headers });
        }

        // Load the main app
        function loadApp() {
            // Load your existing app.js functionality here or include it separately
        }

        } // End of production mode else block
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
