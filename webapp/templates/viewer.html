<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∏ Band Practice</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Firebase Auth Gate -->
    <div id="auth-gate" style="display: none;">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; max-width: 400px;">
                <h1 style="margin-bottom: 20px;">üé∏ Band Practice Pro</h1>
                <p style="color: #666; margin-bottom: 30px;">Sign in with your Google account to continue</p>
                <div id="firebaseui-auth-container"></div>
                <div id="auth-error" style="color: #c33; margin-top: 20px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" style="display: none;">
        <header>
            <div class="header-content">
                <h1>üé∏ Band Practice</h1>
                <div class="user-info">
                    <span id="user-email" class="user-email">Loading...</span>
                    <button id="signout-btn" class="btn btn-small btn-secondary" style="margin-left: 10px;">Sign Out</button>
                </div>
                <div class="header-actions">
                    <button id="change-playlist-btn" class="btn btn-secondary">
                        <span class="icon">üìã</span> Change Playlist
                    </button>
                    <button id="sync-playlist-btn" class="btn btn-primary">
                        <span class="icon">üîÑ</span> Sync Playlist
                    </button>
                    <button id="refresh-song-btn" class="btn btn-secondary" disabled>
                        <span class="icon">‚ôªÔ∏è</span> Refresh Lyrics
                    </button>
                </div>
            </div>
            <div class="controls">
                <div class="song-selector">
                    <label for="song-select">Select Song:</label>
                    <select id="song-select" class="song-select">
                        <option value="">Loading songs...</option>
                    </select>
                </div>
                <div class="status-bar">
                    <span id="status-message" class="status-message"></span>
                </div>
            </div>
        </header>

        <main class="container">
            <div class="panels">
                <!-- Lyrics Panel -->
                <div class="panel lyrics-panel">
                    <div class="panel-header">
                        <h2>Lyrics</h2>
                        <div class="song-metadata" id="song-metadata"></div>
                    </div>
                    <div class="panel-content" id="lyrics-content">
                        <div class="empty-state">
                            <p>Select a song to view lyrics</p>
                        </div>
                    </div>
                </div>

                <!-- Notes Panel -->
                <div class="panel notes-panel">
                    <div class="panel-header">
                        <h2>Practice Notes</h2>
                        <div class="notes-actions">
                            <button id="edit-notes-btn" class="btn btn-small btn-secondary" disabled>
                                <span class="icon">‚úèÔ∏è</span> Edit
                            </button>
                            <button id="save-notes-btn" class="btn btn-small btn-primary" style="display: none;">
                                <span class="icon">üíæ</span> Save
                            </button>
                            <button id="cancel-edit-btn" class="btn btn-small btn-secondary" style="display: none;">
                                Cancel
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <!-- View Mode -->
                        <div id="notes-view" class="notes-view">
                            <div class="empty-state">
                                <p>Select a song to view notes</p>
                            </div>
                        </div>
                        <!-- Edit Mode -->
                        <div id="notes-edit" class="notes-edit" style="display: none;">
                            <div class="edit-help">
                                <strong>Note Syntax:</strong>
                                <code>Line 12: Your note here</code> or
                                <code>Lines 45-48: Your note here</code>
                            </div>
                            <textarea id="notes-textarea" class="notes-textarea" placeholder="Add your practice notes here...

Example:
Line 12: Heavy kick on 1 and 3
Lines 45-48: Double time, watch for break"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Playlist Dialog -->
        <div id="playlist-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3>Change Spotify Playlist</h3>
                <input type="text" id="playlist-url-input" class="input"
                       placeholder="https://open.spotify.com/playlist/YOUR_PLAYLIST_ID">
                <div class="dialog-actions">
                    <button id="playlist-cancel-btn" class="btn btn-secondary">Cancel</button>
                    <button id="playlist-save-btn" class="btn btn-primary">Sync New Playlist</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p id="loading-message">Loading...</p>
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="toast-container"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />

    <script>
        // Firebase configuration - replace with your project's config
        const firebaseConfig = {
            apiKey: "{{ config.FIREBASE_API_KEY }}",
            authDomain: "{{ config.FIREBASE_AUTH_DOMAIN }}",
            projectId: "{{ config.FIREBASE_PROJECT_ID }}"
        };

        console.log('üî• Firebase config:', firebaseConfig);
        console.log('üî• Step 1: Initializing Firebase...');

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        console.log('üî• Step 2: Firebase initialized');

        const auth = firebase.auth();
        console.log('üî• Step 3: Auth instance created');

        // Set persistence to LOCAL (survives page reloads)
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
            console.log('üî• Step 4: Persistence set to LOCAL');
        }).catch((error) => {
            console.error('‚ùå Failed to set persistence:', error);
        });

        // FirebaseUI configuration
        const uiConfig = {
            signInOptions: [
                firebase.auth.GoogleAuthProvider.PROVIDER_ID
            ],
            callbacks: {
                signInSuccessWithAuthResult: (authResult) => {
                    console.log('‚úÖ‚úÖ‚úÖ SIGN IN SUCCESS CALLBACK FIRED ‚úÖ‚úÖ‚úÖ');
                    console.log('User email:', authResult.user.email);
                    console.log('User object:', authResult.user);
                    // Don't redirect - let onAuthStateChanged handle it
                    return false;
                },
                signInFailure: (error) => {
                    console.error('‚ùå‚ùå‚ùå SIGN IN FAILURE ‚ùå‚ùå‚ùå', error);
                    return Promise.resolve();
                },
                uiShown: () => {
                    console.log('üé® FirebaseUI widget shown');
                }
            }
        };

        console.log('üî• Step 5: Creating FirebaseUI instance...');
        const ui = new firebaseui.auth.AuthUI(auth);
        console.log('üî• Step 6: FirebaseUI created');

        let currentUser = null;
        let idToken = null;

        // Auth state observer
        console.log('üî• Step 7: Setting up onAuthStateChanged listener...');
        auth.onAuthStateChanged(async (user) => {
            console.log('üîêüîêüîê AUTH STATE CHANGED CALLBACK FIRED üîêüîêüîê');
            console.log('User object:', user);
            console.log('User email:', user ? user.email : 'NULL');

            if (user) {
                // User is signed in
                console.log('‚úÖ USER IS SIGNED IN');
                try {
                    console.log('üìù Step A: Getting ID token...');
                    idToken = await user.getIdToken();
                    console.log('‚úÖ Step B: Got ID token (first 50 chars):', idToken.substring(0, 50));
                    currentUser = user;

                    // Check if user is allowed by making a test API call
                    console.log('üåê Step C: About to call /api/user with Authorization header...');
                    console.log('Authorization header will be:', `Bearer ${idToken.substring(0, 50)}...`);

                    const response = await fetch('/api/user', {
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });

                    console.log('üì• Step D: /api/user response received. Status:', response.status);

                    if (response.ok) {
                        // User is authorized
                        console.log('‚úÖ‚úÖ‚úÖ USER AUTHORIZED ‚úÖ‚úÖ‚úÖ');
                        console.log('User email:', user.email);
                        console.log('Step E: Hiding auth gate, showing main app');
                        document.getElementById('auth-gate').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        document.getElementById('user-email').textContent = user.email;

                        console.log('Step F: Checking if window.initializeApp exists:', typeof window.initializeApp);
                        // Initialize the main app with authenticated API calls
                        if (window.initializeApp) {
                            console.log('Step G: Calling window.initializeApp...');
                            window.initializeApp(apiCall);
                            console.log('Step H: window.initializeApp completed');
                        } else {
                            console.error('‚ùå window.initializeApp is not defined!');
                        }
                    } else {
                        // User not authorized
                        const errorText = await response.text();
                        console.error('‚ùå‚ùå‚ùå AUTHORIZATION FAILED ‚ùå‚ùå‚ùå');
                        console.error('Response status:', response.status);
                        console.error('Response body:', errorText);
                        console.error('User email:', user.email);
                        console.error('ID token (first 50 chars):', idToken.substring(0, 50));
                        document.getElementById('auth-error').textContent =
                            'You are not authorized to access this application. Contact the admin.';
                        document.getElementById('auth-error').style.display = 'block';
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error('üí•üí•üí• ERROR DURING AUTHENTICATION üí•üí•üí•');
                    console.error('Error:', error);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    document.getElementById('auth-error').textContent = 'Authentication error. Please try again.';
                    document.getElementById('auth-error').style.display = 'block';
                }
            } else {
                // User is signed out
                console.log('üëãüëãüëã USER IS NULL - SIGNED OUT üëãüëãüëã');
                console.log('Step X: Hiding main app, showing auth gate');
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('auth-gate').style.display = 'block';
                console.log('Step Y: Starting FirebaseUI...');
                ui.start('#firebaseui-auth-container', uiConfig);
                console.log('Step Z: FirebaseUI started');
            }
        });

        console.log('üî• Step 8: onAuthStateChanged listener registered');

        // Sign out handler
        document.getElementById('signout-btn')?.addEventListener('click', () => {
            auth.signOut();
        });

        // Helper function to make authenticated API calls
        async function apiCall(url, options = {}) {
            if (!idToken) {
                idToken = await currentUser.getIdToken(true);
            }

            const headers = {
                'Authorization': `Bearer ${idToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            return fetch(url, { ...options, headers });
        }

        // Load the main app
        function loadApp() {
            // Load your existing app.js functionality here or include it separately
        }
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
