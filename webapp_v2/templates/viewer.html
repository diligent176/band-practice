<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Band Practice Pro</title>
    
    <!-- High-quality multi-resolution favicons -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Firebase Auth Gate -->
    <div id="auth-gate" style="display: none;">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; max-width: 400px;">
                <h1 style="margin-bottom: 30px; color: #333; font-size: 28px; font-weight: 700;">🎸 Band Practice Pro</h1>
                <p style="color: #666; margin-bottom: 30px;">Sign in with your Google account to continue</p>
                <div id="firebaseui-auth-container"></div>
                <div id="auth-error" style="color: #c33; margin-top: 20px; display: none;"></div>
                <p style="font-size: 10px; color: #aaa; margin-top: 20px; margin-bottom: 0;">Thanks to <a href="https://getsongbpm.com" target="_blank" style="color: #bbb; text-decoration: none;">getsongbpm.com</a> for BPM data.</p>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" style="display: none;">
        <header>
            <div class="header-single-row">
                <h1><i class="fa-solid fa-guitar"></i> <span class="app-title-text">Band Practice Pro</span></h1>
                <div class="status-bar">
                    <button id="collection-btn" class="btn btn-subtle" title="Switch Collection (X)">
                        <i class="fa-solid fa-layer-group"></i> <span id="current-collection-name">Collection...</span>
                    </button>
                    <button id="import-playlist-btn" class="btn btn-subtle" title="Import songs from Spotify playlist (P)">
                        <i class="fa-solid fa-list"></i> Playlist...
                    </button>
                    <button id="open-song-selector-btn" class="btn btn-subtle" title="Open song selector (S)">
                        <i class="fa-solid fa-music"></i> Song...
                    </button>
                    <span id="status-message" class="status-message"></span>
                </div>
                <!-- Simple Audio Player (hidden audio element) -->
                <audio id="audio-player" style="display: none;"></audio>

                <!-- Minimal Player UI -->
                <div id="mini-player" class="mini-player" style="display: none;">
                    <div class="mini-player-art">
                        <img id="mini-player-art-img" src="" alt="">
                    </div>
                    <div class="mini-player-info">
                        <div id="mini-player-title" class="mini-player-title">Song Title</div>
                        <div id="mini-player-artist" class="mini-player-artist">Artist</div>
                    </div>
                    <div class="mini-player-controls">
                        <button id="mini-player-play-btn" class="mini-player-btn">
                            <i class="fa-solid fa-play"></i>
                        </button>
                    </div>
                </div>
                <div class="font-size-selector">
                    <i class="fa-solid fa-text-height" title="Font Size"></i>
                    <select id="font-size-select" class="font-size-select">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                        <option value="xlarge">X-Large</option>
                        <option value="xxlarge">XX-Large</option>
                        <option value="xxxlarge">XXX-Large</option>
                    </select>
                </div>
                <div class="keyboard-shortcuts-help" title="Keyboard Shortcuts">
                    <i class="fa-solid fa-circle-question"></i>
                    <div class="help-card">
                        <div class="help-card-header">
                            <i class="fa-solid fa-keyboard"></i>
                            <span>Keyboard Shortcuts</span>
                            <span class="help-toggle-hint">Press / or ? to toggle this help.</span>
                        </div>
                        <div class="help-card-content">
                            <div class="help-column">
                                <div class="help-section">
                                    <div class="help-section-title">Navigation</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>X</kbd></div>
                                        <i class="fa-solid fa-layer-group help-icon"></i>
                                        <span>Collection</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>P</kbd></div>
                                        <i class="fa-brands fa-spotify help-icon"></i>
                                        <span>Import Playlist</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>S</kbd></div>
                                        <i class="fa-solid fa-music help-icon"></i>
                                        <span>Song Selector</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>↑</kbd><kbd>↓</kbd></div>
                                        <i class="fa-solid fa-arrows-up-down help-icon"></i>
                                        <span>Navigate Notes</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Home</kbd><kbd>End</kbd></div>
                                        <i class="fa-solid fa-arrows-up-down-left-right help-icon"></i>
                                        <span>First/Last Note</span>
                                    </div>
                                </div>

                                <div class="help-section">
                                    <div class="help-section-title">View</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>I</kbd></div>
                                        <i class="fa-solid fa-drum help-icon"></i>
                                        <span>Toggle BPM Indicator</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>C</kbd></div>
                                        <i class="fa-solid fa-columns help-icon"></i>
                                        <span>Toggle Columns</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>R</kbd></div>
                                        <i class="fa-solid fa-left-right help-icon"></i>
                                        <span>Resize Panels</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Alt</kbd><kbd>↑</kbd><kbd>↓</kbd></div>
                                        <i class="fa-solid fa-text-height help-icon"></i>
                                        <span>Adjust Font Size</span>
                                    </div>
                                </div>

                            </div>

                            <div class="help-column">
                                <div class="help-section">
                                    <div class="help-section-title">Playback</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Space</kbd></div>
                                        <i class="fa-solid fa-circle-play help-icon"></i>
                                        <span>Play/Pause</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>T</kbd></div>
                                        <i class="fa-solid fa-rotate-left help-icon"></i>
                                        <span>Restart Track</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>M</kbd></div>
                                        <i class="fa-solid fa-volume-xmark help-icon"></i>
                                        <span>Toggle Mute</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>←</kbd><kbd>→</kbd></div>
                                        <i class="fa-solid fa-left-right help-icon"></i>
                                        <span>Back/Forward 5s</span>
                                    </div>
                                </div>

                                <div class="help-section">
                                    <div class="help-section-title">Editing</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>E</kbd></div>
                                        <i class="fa-solid fa-file-lines help-icon"></i>
                                        <span>Edit Lyrics</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>N</kbd></div>
                                        <i class="fa-solid fa-pen-to-square help-icon"></i>
                                        <span>Edit Notes</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>B</kbd></div>
                                        <i class="fa-solid fa-drum help-icon"></i>
                                        <span>Set BPM</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>F</kbd></div>
                                        <i class="fa-solid fa-cloud-arrow-down help-icon"></i>
                                        <span>Fetch BPM</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>.</kbd></div>
                                        <i class="fa-solid fa-hand-pointer help-icon"></i>
                                        <span>BPM Tap Trainer</span>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="user-info" id="user-info-container">
                    <span id="user-email" class="user-email">Loading...</span>
                    <i class="fa-solid fa-arrow-right-from-bracket signout-icon" id="signout-icon" title="Sign Out"></i>
                </div>
            </div>
        </header>

        <main class="container">
            <div class="panels">
                <!-- Lyrics Panel -->
                <div class="panel lyrics-panel" id="lyrics-panel">
                    <div class="panel-header">
                        <div class="lyrics-header-left">
                            <i class="fa-solid fa-music" id="song-icon" style="display: none;"></i>
                            <h2 id="lyrics-heading">Lyrics</h2>
                            <div class="customization-badge-main" id="customization-badge-main" style="display: none;" title="Custom Lyric">
                                <i class="fa-solid fa-pen"></i>
                            </div>
                        </div>
                        <div class="song-metadata" id="song-metadata"></div>
                                                <div class="lyrics-header-actions">
                            <button id="toggle-columns-btn" class="btn btn-icon" title="Columns (C)">
                                <i class="fa-solid fa-columns"></i>
                            </button>
                            <button id="edit-lyrics-btn" class="btn btn-icon" disabled title="Edit lyric (E)">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button id="set-bpm-btn" class="btn btn-icon" disabled title="Set BPM manually (B)">
                                <i class="fa-solid fa-hashtag"></i>
                            </button>
                            <button id="fetch-bpm-btn" class="btn btn-icon" disabled title="Fetch BPM online (F)">
                                <i class="fa-solid fa-music"></i>
                            </button>
                            <button id="refresh-song-btn" class="btn btn-icon" disabled title="Fetch lyrics">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                    </div>
                    <div class="panel-content" id="lyrics-content">
                        <div id="album-art-float" class="album-art-float" style="display: none;">
                            <img id="album-art-image" src="" alt="Album Art">
                        </div>
                        <div id="lyrics-content-inner" class="lyrics-columns-1">
                            <div class="empty-state">
                                <p>Select a song to view lyrics</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resize Handle -->
                <div class="resize-handle" id="resize-handle"></div>

                <!-- Notes Panel -->
                <div class="panel notes-panel" id="notes-panel">
                    <div class="panel-header">
                        <div class="notes-header-left">
                            <h2>Practice Notes</h2>
                            <button id="edit-notes-btn" class="btn btn-icon" disabled title="Edit notes (N)">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </div>
                        <div class="notes-actions">
                            <button id="save-notes-btn" class="btn btn-small btn-subtle" style="display: none;">
                                <i class="fa-solid fa-floppy-disk"></i> Save
                            </button>
                            <button id="cancel-edit-btn" class="btn btn-small btn-subtle" style="display: none;">
                                Cancel
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <!-- View Mode -->
                        <div id="notes-view" class="notes-view">
                            <div class="empty-state">
                                <p>Select a song to view notes</p>
                            </div>
                        </div>
                        <!-- Edit Mode -->
                        <div id="notes-edit" class="notes-edit" style="display: none;">
                            <div class="edit-help">
                                <strong>Note Syntax:</strong>
                                <code>START: your note here</code><br>
                                <code>10: your note here</code><br>
                                <code>14-16: your note here</code><br>
                                <code>Line 20: your note here</code><br>
                                <code>Lines 22-24: your note here</code><br>
                                <code>END: your note here</code>
                            </div>
                            <textarea id="notes-textarea" class="notes-textarea" placeholder="Add your practice notes here...

Example:
START: with drum fill on 3-4 count
12: Heavy kick on 1 and 3
45-48: Double time, watch for break
END: Third repetition of chorus is acapella"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Collection Selector Dialog -->
        <div id="collection-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-medium">
                <div class="dialog-header">
                    <h3>Select Collection</h3>
                    <button id="collection-dialog-close" class="btn btn-small btn-secondary">✕</button>
                </div>
                <div class="collection-selector-content">
                    <div id="collection-list" class="collection-list">
                        <div class="empty-state"><p>Loading collections...</p></div>
                    </div>
                    <div class="dialog-actions">
                        <button id="new-collection-btn" class="btn btn-primary">
                            <i class="fa-solid fa-plus"></i> New Collection
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Collection Dialog -->
        <div id="new-collection-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3>Create New Collection</h3>
                <div style="margin-bottom: 20px;">
                    <label for="collection-name-input" style="display: block; margin-bottom: 8px; color: var(--text-primary);">Collection Name:</label>
                    <input type="text" id="collection-name-input" class="input" 
                           placeholder="e.g., Reggae Band, Rock Band" 
                           style="width: 100%; padding: 8px; font-size: 16px; margin-bottom: 10px;">
                    <label for="collection-description-input" style="display: block; margin-bottom: 8px; color: var(--text-primary);">Description (optional):</label>
                    <input type="text" id="collection-description-input" class="input" 
                           placeholder="e.g., Songs for my weekend gigs" 
                           style="width: 100%; padding: 8px; font-size: 14px;">
                </div>
                <div class="dialog-actions">
                    <button id="new-collection-cancel-btn" class="btn btn-secondary">
                        <i class="fa-solid fa-xmark"></i> Cancel
                    </button>
                    <button id="new-collection-save-btn" class="btn btn-primary">
                        <i class="fa-solid fa-check"></i> Create
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Collection Dialog -->
        <div id="edit-collection-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3>Edit Collection</h3>
                <div style="margin-bottom: 20px;">
                    <label for="edit-collection-name-input" style="display: block; margin-bottom: 8px; color: var(--text-primary);">Collection Name:</label>
                    <input type="text" id="edit-collection-name-input" class="input"
                           placeholder="e.g., Reggae Band, Rock Band"
                           style="width: 100%; padding: 8px; font-size: 16px; margin-bottom: 10px;">

                    <label for="edit-collection-description-input" style="display: block; margin-bottom: 8px; color: var(--text-primary);">Description (optional):</label>
                    <input type="text" id="edit-collection-description-input" class="input"
                           placeholder="e.g., Songs for my weekend gigs"
                           style="width: 100%; padding: 8px; font-size: 14px; margin-bottom: 15px;">

                    <!-- Shared Collection Toggle -->
                    <div style="margin-bottom: 15px; padding: 12px; background: var(--surface); border-radius: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="edit-collection-shared-checkbox" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                            <div>
                                <div style="font-weight: 500; color: var(--text-primary);">
                                    <i class="fa-solid fa-share-nodes"></i> Shared Collection
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    Make this collection visible to all users (read-only by default)
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Collaborators Section -->
                    <div id="collaborators-section" style="margin-bottom: 15px; padding: 12px; background: var(--surface); border-radius: 8px; display: none;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">
                            <i class="fa-solid fa-user-plus"></i> Collaborators (can edit songs)
                        </label>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                            Add up to 10 collaborators by email address. They can edit lyrics, notes, and BPM.
                        </div>
                        <div id="collaborator-list" style="margin-bottom: 10px;">
                            <!-- Dynamic collaborator chips will be added here -->
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <input type="email"
                                   id="add-collaborator-input"
                                   class="input"
                                   placeholder="email@example.com"
                                   style="flex: 1; padding: 8px; font-size: 14px;">
                            <button id="add-collaborator-btn" class="btn btn-small btn-secondary">
                                <i class="fa-solid fa-plus"></i> Add
                            </button>
                        </div>
                    </div>
                </div>
                <div class="dialog-actions">
                    <button id="edit-collection-cancel-btn" class="btn btn-secondary">
                        <i class="fa-solid fa-xmark"></i> Cancel
                    </button>
                    <button id="edit-collection-save-btn" class="btn btn-primary">
                        <i class="fa-solid fa-check"></i> Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Import Playlist Dialog -->
        <div id="import-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-large dialog-import">
                <div class="dialog-header">
                    <h3>Import Spotify Playlist</h3>
                    <button id="import-dialog-close" class="btn btn-small btn-secondary">✕</button>
                </div>

                <!-- Step 1: Manage Playlists (V2: Link/Unlink) -->
                <div id="import-step-url" class="import-step">
                    <!-- V2: Linked Playlists Section -->
                    <div id="linked-playlists-section" class="playlist-section">
                        <h4 class="playlist-section-header">
                            <i class="fa-solid fa-link"></i> Playlists in This Collection
                        </h4>
                        <div id="linked-playlists-list" class="playlist-list">
                            <div class="empty-state-small">
                                <p>No playlists linked to this collection yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- V2: Other Recent Playlists Section -->
                    <div id="other-playlists-section" class="playlist-section">
                        <h4 class="playlist-section-header">
                            <i class="fa-solid fa-clock-rotate-left"></i> Other Recent Playlists
                        </h4>
                        <div id="other-playlists-list" class="playlist-list">
                            <div class="empty-state-small">
                                <p>No other playlists in memory</p>
                            </div>
                        </div>
                    </div>

                    <!-- V2: Add New Playlist Section -->
                    <div class="playlist-section">
                        <h4 class="playlist-section-header">
                            <i class="fa-solid fa-plus"></i> Add New Playlist
                        </h4>
                        <div class="import-url-section">
                            <label for="import-playlist-url">Spotify Playlist URL:</label>
                            <input type="text" id="import-playlist-url" class="input"
                                   placeholder="https://open.spotify.com/playlist/YOUR_PLAYLIST_ID">
                            <button id="import-load-btn" class="btn btn-primary">
                                <i class="fa-solid fa-link"></i> Link Playlist to Collection
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Lyrics Editor Dialog -->
        <div id="lyrics-editor-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-large">
                <div class="dialog-header">
                    <h3 id="lyrics-editor-title">Edit Lyrics</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="insert-verse-btn" class="btn btn-badge" title="Insert [Verse] heading (replaces selection)">
                            <i class="fa-solid fa-music"></i> Verse (Alt+V)
                        </button>
                        <button id="insert-chorus-btn" class="btn btn-badge" title="Insert [Chorus] heading (replaces selection)">
                            <i class="fa-solid fa-microphone"></i> Chorus (Alt+C)
                        </button>
                        <button id="insert-bridge-btn" class="btn btn-badge" title="Insert [Bridge] heading (replaces selection)">
                            <i class="fa-solid fa-bridge"></i> Bridge (Alt+B)
                        </button>
                        <button id="insert-intro-btn" class="btn btn-badge" title="Insert [Intro] heading (replaces selection)">
                            <i class="fa-solid fa-play"></i> Intro (Alt+I)
                        </button>
                        <button id="insert-outro-btn" class="btn btn-badge" title="Insert [Outro] heading (replaces selection)">
                            <i class="fa-solid fa-stop"></i> Outro (Alt+O)
                        </button>
                        <button id="tighten-lyrics-btn" class="btn btn-badge" title="Remove blank lines around section headers">
                            <i class="fa-solid fa-compress"></i> Tighten (Alt+T)
                        </button>
                    </div>
                </div>
                <div class="lyrics-editor-content">
                    <div class="lyrics-editor-left">
                        <div class="lyrics-editor-wrapper">
                            <div id="lyrics-editor-line-numbers" class="lyrics-editor-line-numbers"></div>
                            <textarea id="lyrics-editor-textarea" class="lyrics-editor-textarea"
                                      placeholder="Enter lyrics here..."></textarea>
                        </div>
                    </div>
                    <div class="lyrics-editor-right">
                        <div class="lyrics-editor-notes-header">
                            <h4>Practice Notes</h4>
                        </div>
                        <div id="lyrics-editor-notes" class="lyrics-editor-notes">
                            <div class="empty-state">
                                <p>No notes for this song</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dialog-actions">
                    <button id="lyrics-editor-cancel-btn" class="btn btn-secondary">
                        <i class="fa-solid fa-xmark"></i> Cancel
                    </button>
                    <button id="lyrics-editor-save-btn" class="btn btn-primary">
                        <i class="fa-solid fa-floppy-disk"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Song Selector Dialog -->
        <div id="song-selector-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog-medium">
                <div class="dialog-header">
                    <h3>Select Song</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="song-count-display" class="song-count-display">0 songs</span>
                        <span class="sort-tip">ALT+T to cycle sort</span>
                        <select id="song-selector-sort" class="song-sort-dropdown">
                            <option value="name">By Song Name</option>
                            <option value="artist">By Artist Name</option>
                            <option value="playlist">By Playlist</option>
                        </select>
                        <button id="song-selector-close" class="btn btn-small btn-secondary">✕</button>
                    </div>
                </div>
                <div class="song-selector-search">
                    <input type="text" id="song-search-input" class="song-search-input" placeholder="Type to filter songs..." autocomplete="off">
                </div>
                <div id="song-selector-list" class="song-selector-list">
                    <div class="empty-state"><p>Loading songs...</p></div>
                </div>
            </div>
        </div>

        <!-- Confirmation Dialog -->
        <div id="confirm-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3 id="confirm-dialog-title">Confirm Action</h3>
                <p id="confirm-dialog-message"></p>
                <div class="dialog-actions">
                    <button id="confirm-dialog-cancel-btn" class="btn btn-secondary">
                        <i class="fa-solid fa-xmark"></i> Cancel
                    </button>
                    <button id="confirm-dialog-confirm-btn" class="btn btn-primary">
                        <i class="fa-solid fa-check"></i> Confirm
                    </button>
                </div>
            </div>
        </div>

        <!-- BPM Input Dialog -->
        <div id="bpm-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3 id="bpm-dialog-title">Set BPM</h3>
                <p id="bpm-dialog-song-info" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;"></p>
                <div style="margin-bottom: 20px;">
                    <label for="bpm-input" style="display: block; margin-bottom: 8px; color: var(--text-primary);">BPM (Beats Per Minute):</label>
                    <input type="number" id="bpm-input" class="input"
                           placeholder="Enter BPM (e.g., 120 or 77.5)"
                           min="1" max="300" step="0.1"
                           style="width: 100%; padding: 8px; font-size: 16px;">
                    <p style="color: var(--text-muted); font-size: 12px; margin-top: 5px;">Typical range: 60-180 BPM (decimals allowed)</p>
                </div>
                <div class="dialog-actions">
                    <button id="bpm-dialog-cancel-btn" class="btn btn-secondary">
                        <i class="fa-solid fa-xmark"></i> Cancel
                    </button>
                    <button id="bpm-dialog-save-btn" class="btn btn-primary">
                        <i class="fa-solid fa-check"></i> Save
                    </button>
                </div>
            </div>
        </div>

        <!-- BPM Tap Trainer Dialog -->
        <div id="bpm-tap-dialog" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3><i class="fa-solid fa-hand-pointer"></i> BPM Tap Trainer</h3>
                <p id="bpm-tap-song-info" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;"></p>
                <div style="margin-bottom: 20px; text-align: center;">
                    <div style="margin-bottom: 15px;">
                        <p style="color: var(--text-primary); margin-bottom: 10px;">Tap the <kbd>.</kbd> (period) key to the beat</p>
                        <p style="color: var(--text-muted); font-size: 13px;">Tap at least 4 times for accurate detection</p>
                        <p style="color: var(--text-muted); font-size: 13px;">Use <kbd>↑</kbd> <kbd>↓</kbd> to fine-tune by 0.1 BPM</p>
                    </div>
                    <div id="bpm-tap-display" style="font-size: 48px; font-weight: bold; color: var(--accent-primary); margin: 20px 0; font-family: monospace;">
                        --.-
                    </div>
                    <div id="bpm-tap-count" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">
                        Taps: 0
                    </div>
                    <button id="bpm-tap-reset-btn" class="btn btn-secondary" style="margin-top: 10px;">
                        <i class="fa-solid fa-rotate-left"></i> Reset
                    </button>
                </div>
                <div class="dialog-actions">
                    <button id="bpm-tap-cancel-btn" class="btn btn-secondary">
                        <i class="fa-solid fa-xmark"></i> Cancel
                    </button>
                    <button id="bpm-tap-save-btn" class="btn btn-primary" disabled>
                        <i class="fa-solid fa-check"></i> Save BPM
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p id="loading-message">Loading...</p>
            <div id="loading-details" style="display: none; margin-top: 20px; text-align: center; max-width: 400px;">
                <div id="playlist-info" style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;"></div>
                <div id="sync-progress" style="font-size: 14px; color: #aaa;"></div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="toast-container"></div>

        <!-- Back to Top Button -->
        <button id="back-to-top-btn" class="back-to-top-btn" title="Back to top">↑</button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />
    
    <!-- Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <script>
        // Always use Firebase Auth (both local and production)
        console.log('🔥 Using Firebase Auth');

        // Firebase configuration - replace with your project's config
        const firebaseConfig = {
            apiKey: "{{ config.FIREBASE_API_KEY }}",
            authDomain: "{{ config.FIREBASE_AUTH_DOMAIN }}",
            projectId: "{{ config.FIREBASE_PROJECT_ID }}"
        };

        console.log('🔥 Firebase config:', firebaseConfig);
        console.log('🔥 Step 1: Initializing Firebase...');

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        console.log('🔥 Step 2: Firebase initialized');

        const auth = firebase.auth();
        console.log('🔥 Step 3: Auth instance created');

        // Set persistence to LOCAL for redirect flow
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
            console.log('🔥 Step 4: Persistence set to LOCAL');
        }).catch((error) => {
            console.error('❌ Failed to set persistence:', error);
        });

        // FirebaseUI configuration
        const uiConfig = {
            signInFlow: 'popup',  // Use popup flow (works reliably on localhost)
            signInOptions: [
                {
                    provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                    customParameters: {
                        prompt: 'select_account'
                    }
                }
            ],
            callbacks: {
                signInSuccessWithAuthResult: (authResult) => {
                    console.log('✅✅✅ SIGN IN SUCCESS CALLBACK FIRED ✅✅✅');
                    console.log('📧 User email:', authResult.user.email);
                    console.log('🆔 User uid:', authResult.user.uid);
                    console.log('✅ Email verified:', authResult.user.emailVerified);
                    console.log('👤 Full user object:', authResult.user);
                    console.log('🔐 Credential:', authResult.credential);
                    console.log('📝 Additional user info:', authResult.additionalUserInfo);
                    console.log('🔄 Auth successful - onAuthStateChanged will handle UI');
                    // Return false - let onAuthStateChanged handle showing the app
                    return false;
                },
                signInFailure: (error) => {
                    console.error('❌❌❌ SIGN IN FAILURE ❌❌❌');
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    console.error('Full error:', error);
                    return Promise.resolve();
                },
                uiShown: () => {
                    console.log('🎨 FirebaseUI widget shown');
                }
            }
        };

        console.log('🔥 Step 5: Creating FirebaseUI instance...');
        const ui = new firebaseui.auth.AuthUI(auth);
        console.log('🔥 Step 6: FirebaseUI created');

        let currentUser = null;
        let idToken = null;
        let authStateCallCount = 0;

        // Auth state observer
        console.log('🔥 Step 7: Setting up onAuthStateChanged listener...');
        auth.onAuthStateChanged(async (user) => {
            authStateCallCount++;
            console.log('🔐🔐🔐 AUTH STATE CHANGED CALLBACK FIRED (Call #' + authStateCallCount + ') 🔐🔐🔐');
            console.log('📍 Current URL:', window.location.href);
            console.log('📍 Has URL params?', window.location.search);
            console.log('User object:', user);
            console.log('User email:', user ? user.email : 'NULL');
            console.log('User emailVerified:', user ? user.emailVerified : 'N/A');
            console.log('User uid:', user ? user.uid : 'N/A');

            // DEBUG: Check if user was signed in before
            if (!user && currentUser) {
                console.error('🚨🚨🚨 USER WAS SIGNED IN BUT NOW IS NULL 🚨🚨🚨');
                console.error('Previous user:', currentUser.email);
                console.error('This means Firebase signed the user out!');
            }

            if (user) {
                // User is signed in
                console.log('✅ USER IS SIGNED IN');
                try {
                    console.log('📝 Step A: Getting ID token...');
                    idToken = await user.getIdToken();  // Get current token
                    console.log('✅ Step B: Got ID token (first 50 chars):', idToken.substring(0, 50));
                    currentUser = user;

                    // Check if user is allowed by making a test API call
                    console.log('🌐 Step C: About to call /api/user with Authorization header...');
                    console.log('Authorization header will be:', `Bearer ${idToken.substring(0, 50)}...`);

                    const response = await fetch('/api/user', {
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });

                    console.log('📥 Step D: /api/user response received. Status:', response.status);

                    if (response.ok) {
                        // User is authorized
                        console.log('✅✅✅ USER AUTHORIZED ✅✅✅');
                        console.log('User email:', user.email);
                        console.log('Step E: Hiding auth gate, showing main app');
                        document.getElementById('auth-gate').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        document.getElementById('user-email').textContent = user.email;

                        // Token refresh is now handled automatically by Firebase SDK
                        // Each apiCall() will request a fresh token, and Firebase caches/refreshes as needed

                        console.log('Step F: Checking if window.initializeApp exists:', typeof window.initializeApp);
                        // Initialize the main app with authenticated API calls
                        if (window.initializeApp) {
                            console.log('Step G: Calling window.initializeApp...');
                            window.initializeApp(apiCall);
                            console.log('Step H: window.initializeApp completed');
                        } else {
                            console.error('❌ window.initializeApp is not defined!');
                        }
                    } else {
                        // User not authorized
                        const errorText = await response.text();
                        console.error('❌❌❌ AUTHORIZATION FAILED ❌❌❌');
                        console.error('Response status:', response.status);
                        console.error('Response body:', errorText);
                        console.error('User email:', user.email);
                        console.error('ID token (first 50 chars):', idToken.substring(0, 50));
                        document.getElementById('auth-error').textContent =
                            'You are not authorized to access this application. Contact the admin.';
                        document.getElementById('auth-error').style.display = 'block';
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error('💥💥💥 ERROR DURING AUTHENTICATION 💥💥💥');
                    console.error('Error:', error);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    document.getElementById('auth-error').textContent = 'Authentication error. Please try again.';
                    document.getElementById('auth-error').style.display = 'block';
                }
            } else {
                // User is signed out
                console.log('👋👋👋 USER IS NULL - SIGNED OUT 👋👋👋');
                console.log('🔍 Checking localStorage for auth data...');
                console.log('localStorage keys:', Object.keys(localStorage));
                console.log('firebase:authUser keys:', Object.keys(localStorage).filter(k => k.includes('firebase')));

                // Check if we're returning from OAuth redirect
                const urlParams = new URLSearchParams(window.location.search);
                console.log('🔍 URL params:', Array.from(urlParams.entries()));

                console.log('Step X: Hiding main app, showing auth gate');
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('auth-gate').style.display = 'block';

                // Check if FirebaseUI is already rendered
                const authContainer = document.getElementById('firebaseui-auth-container');
                console.log('🔍 Auth container children:', authContainer.children.length);

                if (authContainer.children.length === 0) {
                    console.log('Step Y: Starting FirebaseUI...');
                    ui.start('#firebaseui-auth-container', uiConfig);
                    console.log('Step Z: FirebaseUI started');
                } else {
                    console.log('⚠️ FirebaseUI already rendered, not starting again');
                }
            }
        });

        console.log('🔥 Step 8: onAuthStateChanged listener registered');

        // Sign out handler
        document.getElementById('signout-icon')?.addEventListener('click', () => {
            auth.signOut();
        });

        // Helper function to make authenticated API calls
        async function apiCall(url, options = {}) {
            // Always get the current token (Firebase SDK caches it and only refreshes if needed)
            if (currentUser) {
                idToken = await currentUser.getIdToken();
            } else if (!idToken) {
                throw new Error('User not authenticated');
            }

            const headers = {
                'Authorization': `Bearer ${idToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            return fetch(url, { ...options, headers });
        }

    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
