<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Songs - Band Practice Pro v3</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/songs.css') }}">
</head>
<body>
    <!-- Songs View Container -->
    <div class="songs-container">
        <!-- Header -->
        <header class="songs-header">
            <div class="songs-header-left">
                <button id="back-btn" class="btn-icon btn-ghost" title="Back to Collections (ESC)">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="collection-info">
                    <h1 class="collection-name" id="collection-name">Loading...</h1>
                    <div class="song-count" id="song-count">0 songs</div>
                </div>
            </div>
            <div class="songs-header-right">
                <!-- Sort indicator -->
                <div class="sort-indicator" id="sort-indicator" title="Sort mode (ALT+T to toggle)">
                    <i class="fa-solid fa-arrow-down-a-z"></i>
                    <span id="sort-mode-text">By Title</span>
                </div>
                <!-- Search bar -->
                <div class="search-bar">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="song-search" class="search-input" placeholder="Type to filter songs..." autocomplete="off">
                </div>
                <!-- Help toggle -->
                <div class="keyboard-shortcuts-help" id="help-toggle" title="Keyboard Shortcuts">
                    <i class="fa-solid fa-circle-question"></i>
                    <div class="help-card" id="help-card">
                        <div class="help-card-header">
                            <i class="fa-solid fa-keyboard"></i>
                            <span>Keyboard Shortcuts</span>
                            <span class="help-toggle-hint">Press / to toggle</span>
                        </div>
                        <div class="help-card-content">
                            <div class="help-column">
                                <div class="help-section">
                                    <div class="help-section-title">Navigation</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>↑</kbd><kbd>↓</kbd></div>
                                        <i class="fa-solid fa-arrows-up-down help-icon"></i>
                                        <span>Navigate songs</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>PgUp</kbd><kbd>PgDn</kbd></div>
                                        <i class="fa-solid fa-file-lines help-icon"></i>
                                        <span>Page through</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Home</kbd><kbd>End</kbd></div>
                                        <i class="fa-solid fa-arrow-down-1-9 help-icon"></i>
                                        <span>First/Last</span>
                                    </div>
                                </div>
                            </div>
                            <div class="help-column">
                                <div class="help-section">
                                    <div class="help-section-title">Actions</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Enter</kbd></div>
                                        <i class="fa-solid fa-play help-icon"></i>
                                        <span>Open song</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>ALT</kbd><kbd>T</kbd></div>
                                        <i class="fa-solid fa-arrow-down-a-z help-icon"></i>
                                        <span>Toggle sort</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>ESC</kbd></div>
                                        <i class="fa-solid fa-arrow-left help-icon"></i>
                                        <span>Back</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Songs List -->
        <main class="songs-content">
            <div id="songs-list" class="songs-list">
                <!-- Songs will be loaded here -->
                <div class="loading-spinner"></div>
            </div>
        </main>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- Common utilities -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "{{ config.FIREBASE_API_KEY }}",
            authDomain: "{{ config.FIREBASE_AUTH_DOMAIN }}",
            projectId: "{{ config.FIREBASE_PROJECT_ID }}"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Get collection ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const collectionId = urlParams.get('id');

        if (!collectionId) {
            window.location.href = '/';
        }

        // Global state
        let allSongs = [];
        let filteredSongs = [];
        let sortMode = localStorage.getItem('v3_songsSortMode') || 'title'; // 'title', 'artist', 'playlist'
        let selectedSongIndex = -1;
        let currentCollection = null;

        // Auth check
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = '/';
                return;
            }

            // Make current user available globally
            window.currentUser = user;

            // Load collection and songs
            await loadCollectionAndSongs();
        });

        async function loadCollectionAndSongs() {
            try {
                // Load collection data
                currentCollection = await BPP.apiCall(`/api/v3/collections/${collectionId}`);

                // Update header
                document.getElementById('collection-name').textContent = currentCollection.name;

                // Load songs
                const response = await BPP.apiCall(`/api/v3/collections/${collectionId}/songs`);
                allSongs = response.songs || [];

                // Apply sort and filter
                updateSortIndicator();
                filterSongs();

            } catch (error) {
                console.error('Error loading songs:', error);
                BPP.showToast('Failed to load songs', 'error');

                // Redirect back after error
                setTimeout(() => window.location.href = '/', 2000);
            }
        }

        function filterSongs() {
            const searchTerm = document.getElementById('song-search').value.toLowerCase();

            // Filter songs
            if (searchTerm) {
                filteredSongs = allSongs.filter(song => {
                    const title = (song.title || '').toLowerCase();
                    const artist = (song.artist || '').toLowerCase();
                    const album = (song.album || '').toLowerCase();
                    return title.includes(searchTerm) || artist.includes(searchTerm) || album.includes(searchTerm);
                });
            } else {
                filteredSongs = [...allSongs];
            }

            // Apply sort
            applySortMode();

            // Render
            renderSongs();

            // Update count
            updateSongCount();
        }

        function applySortMode() {
            if (sortMode === 'artist') {
                filteredSongs.sort((a, b) => {
                    const artistCompare = (a.artist || '').localeCompare(b.artist || '');
                    return artistCompare !== 0 ? artistCompare : (a.title || '').localeCompare(b.title || '');
                });
            } else if (sortMode === 'title') {
                filteredSongs.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            } else if (sortMode === 'playlist') {
                // Maintain playlist order (already sorted by backend)
                // Songs keep their original order from playlist_positions
            }
        }

        function renderSongs() {
            const container = document.getElementById('songs-list');

            if (filteredSongs.length === 0) {
                const message = allSongs.length === 0
                    ? 'No songs in this collection yet. Link a playlist to add songs!'
                    : 'No songs match your search';
                container.innerHTML = `<div class="empty-state"><p>${message}</p></div>`;
                return;
            }

            let html = '';

            // Render with playlist headers if sorted by playlist
            if (sortMode === 'playlist' && currentCollection.linked_playlists && currentCollection.linked_playlists.length > 0) {
                currentCollection.linked_playlists.forEach(playlist => {
                    // Filter songs from this playlist
                    const playlistSongs = filteredSongs.filter(song =>
                        song.source_playlist_ids && song.source_playlist_ids.includes(playlist.playlist_id)
                    );

                    if (playlistSongs.length === 0) return;

                    // Playlist header
                    html += `
                        <div class="playlist-header">
                            <i class="fa-brands fa-spotify"></i>
                            <span class="playlist-header-name">${escapeHtml(playlist.playlist_name)}</span>
                            <span class="playlist-header-meta">${playlistSongs.length} ${playlistSongs.length === 1 ? 'song' : 'songs'}</span>
                        </div>
                    `;

                    // Songs in this playlist
                    playlistSongs.forEach((song, localIndex) => {
                        const globalIndex = filteredSongs.indexOf(song);
                        html += renderSongItem(song, globalIndex);
                    });
                });
            } else {
                // Regular rendering
                filteredSongs.forEach((song, index) => {
                    html += renderSongItem(song, index);
                });
            }

            container.innerHTML = html;

            // Add click handlers
            container.querySelectorAll('.song-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    openSong(index);
                });
            });

            // Reset selection
            selectedSongIndex = -1;
        }

        function renderSongItem(song, index) {
            const selected = index === selectedSongIndex ? 'selected' : '';
            const hasArtwork = song.album_art_url && song.album_art_url.trim() !== '';
            const hasLyrics = song.lyrics_fetched ? 'has-lyrics' : 'no-lyrics';

            return `
                <div class="song-item ${selected} ${hasLyrics}" data-index="${index}" data-song-id="${song.id}">
                    <div class="song-art-container">
                        ${hasArtwork
                            ? `<img src="${escapeHtml(song.album_art_url)}" alt="Album art" class="song-art" loading="lazy">`
                            : `<div class="song-art-placeholder"><i class="fa-solid fa-music"></i></div>`
                        }
                        ${!song.lyrics_fetched ? '<div class="lyrics-status"><i class="fa-solid fa-hourglass-half"></i></div>' : ''}
                    </div>
                    <div class="song-info">
                        <div class="song-title">${escapeHtml(song.title || 'Unknown')}</div>
                        <div class="song-artist">${escapeHtml(song.artist || 'Unknown')}</div>
                    </div>
                    <div class="song-meta">
                        ${song.bpm && song.bpm !== 'N/A' ? `<span class="song-bpm"><i class="fa-solid fa-drum"></i> ${song.bpm}</span>` : ''}
                    </div>
                </div>
            `;
        }

        function updateSongCount() {
            const countEl = document.getElementById('song-count');
            if (filteredSongs.length === allSongs.length) {
                countEl.textContent = `${allSongs.length} ${allSongs.length === 1 ? 'song' : 'songs'}`;
            } else {
                countEl.textContent = `${filteredSongs.length} of ${allSongs.length} songs`;
            }
        }

        function updateSortIndicator() {
            const indicator = document.getElementById('sort-indicator');
            const text = document.getElementById('sort-mode-text');
            const icon = indicator.querySelector('i');

            if (sortMode === 'title') {
                icon.className = 'fa-solid fa-arrow-down-a-z';
                text.textContent = 'By Title';
            } else if (sortMode === 'artist') {
                icon.className = 'fa-solid fa-user-music';
                text.textContent = 'By Artist';
            } else if (sortMode === 'playlist') {
                icon.className = 'fa-brands fa-spotify';
                text.textContent = 'By Playlist';
            }
        }

        function toggleSortMode() {
            // Cycle: title → artist → playlist → title
            if (sortMode === 'title') {
                sortMode = 'artist';
            } else if (sortMode === 'artist') {
                sortMode = 'playlist';
            } else {
                sortMode = 'title';
            }

            // Save preference
            localStorage.setItem('v3_songsSortMode', sortMode);

            // Update UI
            updateSortIndicator();
            filterSongs();
        }

        function openSong(index) {
            if (index < 0 || index >= filteredSongs.length) return;

            const song = filteredSongs[index];
            console.log('Opening song:', song.title);

            // TODO: Navigate to PLAYER view (Phase 7)
            BPP.showToast(`Opening "${song.title}"... (Player not implemented yet)`, 'info');
        }

        function updateSelection(index) {
            // Remove previous selection
            document.querySelectorAll('.song-item.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Add new selection
            if (index >= 0 && index < filteredSongs.length) {
                const item = document.querySelector(`.song-item[data-index="${index}"]`);
                if (item) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }

            selectedSongIndex = index;
        }

        function navigateList(direction) {
            let newIndex = selectedSongIndex;

            if (direction === 'down') {
                newIndex = Math.min(selectedSongIndex + 1, filteredSongs.length - 1);
            } else if (direction === 'up') {
                newIndex = Math.max(selectedSongIndex - 1, 0);
            } else if (direction === 'pagedown') {
                newIndex = Math.min(selectedSongIndex + 10, filteredSongs.length - 1);
            } else if (direction === 'pageup') {
                newIndex = Math.max(selectedSongIndex - 10, 0);
            } else if (direction === 'home') {
                newIndex = 0;
            } else if (direction === 'end') {
                newIndex = filteredSongs.length - 1;
            }

            updateSelection(newIndex);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event handlers
        document.getElementById('back-btn').addEventListener('click', () => {
            window.location.href = '/';
        });

        // Search input with debounce
        let searchDebounce;
        document.getElementById('song-search').addEventListener('input', () => {
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(filterSongs, 150);
        });

        // Help card toggle
        const helpCard = document.getElementById('help-card');
        let helpCardVisible = false;

        function toggleHelpCard() {
            helpCardVisible = !helpCardVisible;
            if (helpCardVisible) {
                helpCard.style.opacity = '1';
                helpCard.style.visibility = 'visible';
                helpCard.style.transform = 'translateY(0)';
            } else {
                helpCard.style.opacity = '0';
                helpCard.style.visibility = 'hidden';
                helpCard.style.transform = 'translateY(-8px)';
            }
        }

        document.getElementById('help-toggle').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleHelpCard();
        });

        document.addEventListener('click', (e) => {
            if (helpCardVisible && !e.target.closest('.keyboard-shortcuts-help')) {
                toggleHelpCard();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const isTyping = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';

            // / or ? toggles help (even when typing)
            if ((e.key === '/' || e.key === '?') && !isTyping) {
                e.preventDefault();
                toggleHelpCard();
                return;
            }

            // Escape closes help or goes back
            if (e.key === 'Escape') {
                if (helpCardVisible) {
                    toggleHelpCard();
                } else {
                    window.location.href = '/';
                }
                return;
            }

            // Don't handle other keys if typing
            if (isTyping) return;

            // Arrow keys
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateList('down');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateList('up');
            } else if (e.key === 'PageDown') {
                e.preventDefault();
                navigateList('pagedown');
            } else if (e.key === 'PageUp') {
                e.preventDefault();
                navigateList('pageup');
            } else if (e.key === 'Home') {
                e.preventDefault();
                navigateList('home');
            } else if (e.key === 'End') {
                e.preventDefault();
                navigateList('end');
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedSongIndex >= 0) {
                    openSong(selectedSongIndex);
                }
            } else if (e.altKey && (e.key === 't' || e.key === 'T')) {
                e.preventDefault();
                toggleSortMode();
            } else if (e.key.length === 1 && /[a-zA-Z0-9]/.test(e.key)) {
                // Any alphanumeric key focuses search
                document.getElementById('song-search').focus();
            }
        });
    </script>
</body>
</html>
