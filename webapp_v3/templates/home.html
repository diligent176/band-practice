<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Band Practice Pro</title>

    <!-- High-quality multi-resolution favicons -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/songs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/player.css') }}">
</head>
<body>
    <!-- Firebase Auth Gate -->
    <div id="auth-gate" style="display: none;">
        <div class="auth-gate-container">
            <div class="auth-gate-background"></div>
            <div class="auth-gate-content">
                <div class="auth-gate-logo">
                    <img src="{{ url_for('static', filename='favicon.svg') }}" alt="Band Practice Pro" class="auth-logo-icon">
                </div>
                <h1 class="auth-gate-title">
                    <span class="auth-title-gradient">Band Practice Pro</span>
                </h1>
                <p class="auth-gate-subtitle">Your reggae-powered practice companion</p>
                <div class="auth-gate-divider"></div>
                <div id="firebaseui-auth-container"></div>
                <div id="auth-error" class="auth-error" style="display: none;"></div>
                <p class="auth-gate-footer">Thanks to <a href="https://getsongbpm.com" target="_blank">getsongbpm.com</a> for BPM data.</p>
            </div>
        </div>
    </div>

    <!-- Main App - SPA with Multiple Views (shown after auth) -->
    <div id="main-app" class="home-container" style="display: none;">

        <!-- COLLECTIONS VIEW -->
        <div id="collections-view" class="view active">
        <!-- Header -->
        <header class="home-header">
            <div class="home-header-left">
                <h1 class="home-title">
                    <i class="fa-solid fa-guitar"></i>
                    Band Practice Pro
                </h1>
            </div>
            <div class="home-header-right">
                <div class="keyboard-shortcuts-help" id="help-toggle" title="Keyboard Shortcuts - Collections">
                    <i class="fa-solid fa-circle-question"></i>
                    <div class="help-card" id="help-card">
                        <div class="help-card-header">
                            <i class="fa-solid fa-keyboard"></i>
                            <span>Keyboard Shortcuts - Collections</span>
                            <span class="help-toggle-hint">Press / or ? to toggle help</span>
                        </div>
                        <div class="help-card-content">
                            <div class="help-column">
                                <div class="help-section">
                                    <div class="help-section-title">Navigation</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>↑</kbd><kbd>↓</kbd></div>
                                        <i class="fa-solid fa-arrows-up-down help-icon"></i>
                                        <span>Navigate grid</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Home</kbd><kbd>End</kbd></div>
                                        <i class="fa-solid fa-arrow-down-1-9 help-icon"></i>
                                        <span>First/Last</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Enter</kbd></div>
                                        <i class="fa-solid fa-folder-open help-icon"></i>
                                        <span>Open</span>
                                    </div>
                                </div>
                            </div>
                            <div class="help-column">
                                <div class="help-section">
                                    <div class="help-section-title">Actions</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>N</kbd></div>
                                        <i class="fa-solid fa-plus help-icon"></i>
                                        <span>New</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>E</kbd></div>
                                        <i class="fa-solid fa-gear help-icon"></i>
                                        <span>Edit</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>P</kbd></div>
                                        <i class="fa-brands fa-spotify help-icon"></i>
                                        <span>Playlists</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Del</kbd></div>
                                        <i class="fa-solid fa-trash help-icon"></i>
                                        <span>Delete</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="signout-btn" class="btn-icon btn-ghost" title="Logout">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="home-content">
            <!-- Your Collections Section -->
            <section class="collections-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">
                            <i class="fa-solid fa-folder"></i>
                            Your Collections
                        </h2>
                        <button id="new-collection-btn" class="btn btn-primary btn-sm">
                            <i class="fa-solid fa-plus"></i>
                            New Collection
                        </button>
                    </div>
                </div>
                <div id="owned-collections" class="collections-grid">
                    <!-- Collections will be loaded here -->
                    <div class="loading-spinner"></div>
                </div>
            </section>

            <!-- Shared Collections Section -->
            <section class="collections-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fa-solid fa-users"></i>
                        Shared With You
                    </h2>
                </div>
                <div id="shared-collections" class="collections-grid">
                    <!-- Shared collections will be loaded here -->
                </div>
            </section>

            <!-- Public Collections Section -->
            <section class="collections-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fa-solid fa-globe"></i>
                        Browse Public Collections
                    </h2>
                </div>
                <div id="public-collections" class="collections-grid">
                    <!-- Public collections will be loaded here -->
                </div>
            </section>
        </main>
        </div>
        <!-- End Collections View -->

        <!-- SONGS VIEW -->
        <div id="songs-view" class="view">
            <!-- Songs Header -->
            <header class="songs-header">
                <div class="songs-header-left">
                    <button id="songs-back-btn" class="btn-icon btn-ghost" title="Back to Collections (ESC)">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div class="collection-info">
                        <h1 class="collection-name" id="songs-collection-name">Loading...</h1>
                        <div class="song-count" id="songs-count">0 songs</div>
                    </div>
                </div>
                <div class="songs-header-right">
                    <!-- Sort indicator -->
                    <div class="sort-indicator" id="sort-indicator" title="Sort mode (ALT+T to toggle)">
                        <i class="fa-solid fa-arrow-down-a-z"></i>
                        <span id="sort-mode-text">By Title</span>
                    </div>
                    <!-- Search bar -->
                    <div class="search-bar">
                        <i class="fa-solid fa-search"></i>
                        <input type="text" id="song-search" class="search-input" placeholder="Type to filter songs..." autocomplete="off">
                    </div>
                    <!-- Help toggle -->
                    <div class="keyboard-shortcuts-help" id="songs-help-toggle" title="Keyboard Shortcuts - Songs">
                        <i class="fa-solid fa-circle-question"></i>
                        <div class="help-card" id="songs-help-card">
                            <div class="help-card-header">
                                <i class="fa-solid fa-keyboard"></i>
                                <span>Keyboard Shortcuts - Songs</span>
                                <span class="help-toggle-hint">Press / or ? to toggle help</span>
                            </div>
                            <div class="help-card-content">
                                <div class="help-column">
                                    <div class="help-section">
                                        <div class="help-section-title">Navigation</div>
                                        <div class="help-item">
                                            <div class="help-keys"><kbd>↑</kbd><kbd>↓</kbd><kbd>→</kbd></div>
                                            <i class="fa-solid fa-arrows-up-down help-icon"></i>
                                            <span>Navigate songs</span>
                                        </div>
                                        <div class="help-item">
                                            <div class="help-keys"><kbd>Home</kbd><kbd>End</kbd></div>
                                            <i class="fa-solid fa-arrow-down-1-9 help-icon"></i>
                                            <span>First/Last</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="help-column">
                                    <div class="help-section">
                                        <div class="help-section-title">Actions</div>
                                        <div class="help-item">
                                            <div class="help-keys"><kbd>Enter</kbd></div>
                                            <i class="fa-solid fa-play help-icon"></i>
                                            <span>Open song</span>
                                        </div>
                                        <div class="help-item">
                                            <div class="help-keys"><kbd>TAB</kbd></div>
                                            <i class="fa-solid fa-arrow-down-a-z help-icon"></i>
                                            <span>Toggle sort</span>
                                        </div>
                                        <div class="help-item">
                                            <div class="help-keys"><kbd>ESC</kbd></div>
                                            <i class="fa-solid fa-arrow-left help-icon"></i>
                                            <span>Back</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Logout -->
                    <button id="songs-logout-btn" class="btn-icon btn-ghost" title="Logout" onclick="firebase.auth().signOut()">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </header>

            <!-- Songs List -->
            <main class="songs-content">
                <div id="songs-list" class="songs-list">
                    <!-- Songs will be loaded here -->
                    <div class="loading-spinner"></div>
                </div>
            </main>
        </div>
        <!-- End Songs View -->

        <!-- PLAYER VIEW -->
        <div id="player-view" class="view">
            <!-- Player Top Nav (Fixed) -->
            <div class="player-top-nav">
                <!-- Back Button (Fixed Left) -->
                <button id="player-back-btn" class="btn-icon btn-ghost player-back-btn" title="Back to Songs (ESC)">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>

                <!-- Album Art -->
                <div class="player-album-art-container">
                    <img id="player-album-art" src="/static/favicon.svg" alt="Album Art" class="player-album-art">
                </div>

                <!-- Song Metadata -->
                <div class="player-song-info">
                    <div id="player-song-title" class="player-song-title">Song Title</div>
                    <div id="player-artist" class="player-artist">Artist</div>
                </div>

                <!-- Central Player Controls Container -->
                <div class="player-center-controls">
                    <!-- BPM Display & Flasher -->
                    <div id="bpm-indicator-block" class="bpm-indicator-block" title="Toggle BPM metronome (I)">
                        <i class="fa-solid fa-drum"></i>
                        <span id="player-bpm" class="player-bpm-value">--</span>
                    </div>

                    <!-- Playback Controls -->
                    <div class="player-controls">
                        <button id="player-prev-btn" class="btn-icon btn-player" title="Previous song (B)">
                            <i class="fa-solid fa-backward"></i>
                        </button>
                        <button id="player-play-btn" class="btn-icon btn-player btn-play-large" title="Play/Pause (Space)">
                            <i class="fa-solid fa-play"></i>
                            <span id="player-play-text" style="display: none; margin-left: 8px; font-size: 14px;">Play in Spotify</span>
                        </button>
                        <button id="player-next-btn" class="btn-icon btn-player" title="Next song (F)">
                            <i class="fa-solid fa-forward"></i>
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div class="player-progress-container">
                        <span id="player-current-time" class="player-time">0:00</span>
                        <div class="player-progress-bar">
                            <div id="player-progress-fill" class="player-progress-fill"></div>
                        </div>
                        <span id="player-duration" class="player-time">0:00</span>
                    </div>

                    <!-- View Controls (Columns & Font) -->
                    <div class="player-view-options">
                        <button id="player-toggle-columns" class="btn-icon btn-ghost" title="Toggle columns (C)">
                            <i class="fa-solid fa-columns"></i>
                        </button>
                        <button id="player-font-decrease" class="btn-icon btn-ghost" title="Decrease font (Alt+Down)">
                            <i class="fa-solid fa-minus"></i>
                        </button>
                        <button id="player-font-increase" class="btn-icon btn-ghost" title="Increase font (Alt+Up)">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Help + Logout (Fixed Right) -->
                <div class="player-top-nav-right">
                    <!-- Help Toggle -->
                    <div class="keyboard-shortcuts-help" id="player-help-toggle" title="Keyboard Shortcuts - Lyrics/Player">
                    <i class="fa-solid fa-circle-question"></i>
                    <div class="help-card" id="player-help-card">
                        <div class="help-card-header">
                            <i class="fa-solid fa-keyboard"></i>
                            <span>Keyboard Shortcuts - Lyrics/Player</span>
                            <span class="help-toggle-hint">Press / or ? to toggle help</span>
                        </div>
                        <div class="help-card-content">
                            <div class="help-column">
                                <div class="help-section">
                                    <div class="help-section-title">Navigation</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>X</kbd></div>
                                        <i class="fa-solid fa-folder help-icon"></i>
                                        <span>Collections</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>S</kbd></div>
                                        <i class="fa-solid fa-music help-icon"></i>
                                        <span>Songs</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>B</kbd></div>
                                        <i class="fa-solid fa-backward help-icon"></i>
                                        <span>Previous</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>F</kbd></div>
                                        <i class="fa-solid fa-forward help-icon"></i>
                                        <span>Next</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>ESC</kbd></div>
                                        <i class="fa-solid fa-arrow-left help-icon"></i>
                                        <span>Back</span>
                                    </div>
                                </div>
                                <div class="help-section">
                                    <div class="help-section-title">View</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>C</kbd></div>
                                        <i class="fa-solid fa-columns help-icon"></i>
                                        <span>Columns</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>I</kbd></div>
                                        <i class="fa-solid fa-drum help-icon"></i>
                                        <span>BPM Indicator</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Alt</kbd><kbd>↑</kbd><kbd>↓</kbd></div>
                                        <i class="fa-solid fa-text-height help-icon"></i>
                                        <span>Font Size</span>
                                    </div>
                                </div>
                            </div>
                            <div class="help-column">
                                <div class="help-section">
                                    <div class="help-section-title">Playback</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>Space</kbd></div>
                                        <i class="fa-solid fa-play help-icon"></i>
                                        <span>Play/Pause</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>R</kbd></div>
                                        <i class="fa-solid fa-rotate-left help-icon"></i>
                                        <span>Restart</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>M</kbd></div>
                                        <i class="fa-solid fa-volume-xmark help-icon"></i>
                                        <span>Mute</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>←</kbd><kbd>→</kbd></div>
                                        <i class="fa-solid fa-left-right help-icon"></i>
                                        <span>Skip ±5s</span>
                                    </div>
                                </div>
                                <div class="help-section">
                                    <div class="help-section-title">Editing</div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>L</kbd></div>
                                        <i class="fa-solid fa-file-lines help-icon"></i>
                                        <span>Edit Lyrics</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>N</kbd></div>
                                        <i class="fa-solid fa-pen-to-square help-icon"></i>
                                        <span>Edit Notes</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>G</kbd></div>
                                        <i class="fa-solid fa-download help-icon"></i>
                                        <span>Get Lyrics</span>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-keys"><kbd>.</kbd></div>
                                        <i class="fa-solid fa-drum help-icon"></i>
                                        <span>Set Tempo</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Logout -->
                    <button id="player-logout-btn" class="btn-icon btn-ghost" title="Logout" onclick="firebase.auth().signOut()">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>

            <!-- Player Main Content -->
            <div class="player-main">
                <!-- Lyrics Panel (100% width - notes shown as callouts) -->
                <div class="player-lyrics-panel lyrics-columns-3" id="player-lyrics-panel">
                    <div class="empty-state">
                        <p>Loading lyrics...</p>
                    </div>
                </div>

                <!-- Note Callout (positioned absolutely, shown when navigating notes) -->
                <div class="note-callout hidden" id="note-callout">
                    <div class="note-callout-content" id="note-callout-content"></div>
                </div>
            </div>

            <!-- Spotify Connection Prompt Overlay -->
            <div id="spotify-connect-prompt" class="spotify-connect-prompt hidden">
                <div class="spotify-connect-card">
                    <i class="fa-brands fa-spotify" style="font-size: 48px; color: #1DB954;"></i>
                    <h3>Connect Spotify for Playback</h3>
                    <p>Connect your Spotify Premium account to play music directly in the browser.</p>
                    <button onclick="SpotifyPlayer.connectSpotify()" class="btn btn-primary">
                        <i class="fa-brands fa-spotify"></i>
                        Connect Spotify
                    </button>
                </div>
            </div>
        </div>
        <!-- End Player View -->

    </div>
    <!-- End Main App -->

    <!-- New Collection Dialog -->
    <div id="new-collection-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Create New Collection</h3>
                <button class="dialog-close" onclick="BPP.hideDialog('new-collection-dialog')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <div class="mb-md">
                    <label for="collection-name" class="text-sm text-secondary mb-sm">Collection Name</label>
                    <input type="text" id="collection-name" class="input" placeholder="e.g. Summer Gig 2026" autofocus>
                </div>
                <div class="mb-md">
                    <label for="collection-description" class="text-sm text-secondary mb-sm">Description (optional)</label>
                    <input type="text" id="collection-description" class="input" placeholder="Brief description">
                </div>
                <div class="mb-md">
                    <label class="checkbox-label">
                        <input type="checkbox" id="collection-public">
                        <span class="text-sm">Make this collection public</span>
                    </label>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-secondary" onclick="BPP.hideDialog('new-collection-dialog')">Cancel</button>
                <button id="create-collection-btn" class="btn btn-primary">Create Collection</button>
            </div>
        </div>
    </div>

    <!-- Edit Collection Dialog -->
    <div id="edit-collection-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Edit Collection</h3>
                <button class="dialog-close" onclick="BPP.hideDialog('edit-collection-dialog')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <input type="hidden" id="edit-collection-id">
                <div class="mb-md">
                    <label for="edit-collection-name" class="text-sm text-secondary mb-sm">Collection Name</label>
                    <input type="text" id="edit-collection-name" class="input" placeholder="Collection name" autofocus>
                </div>
                <div class="mb-md">
                    <label for="edit-collection-description" class="text-sm text-secondary mb-sm">Description (optional)</label>
                    <input type="text" id="edit-collection-description" class="input" placeholder="Brief description">
                </div>
                <div class="mb-md">
                    <label class="checkbox-label">
                        <input type="checkbox" id="edit-collection-public">
                        <span class="text-sm">Make this collection public</span>
                    </label>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-secondary" onclick="BPP.hideDialog('edit-collection-dialog')">Cancel</button>
                <button id="save-collection-btn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Dialog -->
    <div id="delete-collection-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Delete Collection</h3>
                <button class="dialog-close" onclick="BPP.hideDialog('delete-collection-dialog')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <input type="hidden" id="delete-collection-id">
                <p class="text-secondary">
                    Are you sure you want to delete "<span id="delete-collection-name" class="text-primary"></span>"?
                </p>
                <p class="text-sm text-muted">
                    This will permanently delete the collection and all its songs. This action cannot be undone.
                </p>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-secondary" onclick="BPP.hideDialog('delete-collection-dialog')">Cancel</button>
                <button id="confirm-delete-btn" class="btn btn-primary" style="background: rgba(197, 48, 48, 0.7);">Delete Collection</button>
            </div>
        </div>
    </div>

    <!-- Fetch Lyrics Dialog -->
    <div id="fetch-lyrics-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Fetch Lyrics from Genius</h3>
                <button class="dialog-close" onclick="BPP.hideDialog('fetch-lyrics-dialog')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <p class="text-secondary">
                    Fetch lyrics from Genius? This action overwrites any custom lyrics saved for this song.
                </p>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-secondary" onclick="BPP.hideDialog('fetch-lyrics-dialog')">Cancel</button>
                <button id="confirm-fetch-lyrics-btn" class="btn btn-primary">Fetch Lyrics</button>
            </div>
        </div>
    </div>

    <!-- Manage Linked Playlists Dialog -->
    <div id="link-playlist-dialog" class="dialog-overlay hidden">
        <div class="dialog dialog-large">
            <div class="dialog-header">
                <h3 class="dialog-title">Manage Linked Playlists</h3>
                <button class="dialog-close" onclick="BPP.hideDialog('link-playlist-dialog')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <input type="hidden" id="link-playlist-collection-id">

                <!-- 1. Paste New Playlist URL (FOCUSED) -->
                <div class="mb-md">
                    <label for="playlist-url" class="text-sm text-secondary mb-sm">Add Spotify Playlist</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="playlist-url" class="input" placeholder="https://open.spotify.com/playlist/..." autofocus autocomplete="off" style="flex: 1;">
                        <button id="add-playlist-btn" class="btn btn-primary" title="Add playlist">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- 2. Linked Playlists (set order) -->
                <div id="linked-playlists-section" class="mb-md" style="display: none;">
                    <label class="text-sm text-secondary mb-sm">
                        Linked Playlists
                        <span style="margin-left: 8px; font-size: 11px; opacity: 0.6;"><i class="fa-solid fa-grip-vertical"></i> Drag to reorder</span>
                    </label>
                    <div id="linked-playlists-list" class="recent-playlists-list">
                        <!-- Linked playlists will be rendered here -->
                    </div>
                </div>

                <!-- 3. Other Playlists (recent memory) -->
                <div id="other-playlists-section" class="mb-md" style="display: none;">
                    <label class="text-sm text-secondary mb-sm">Other Playlists</label>
                    <div id="other-playlists-list" class="recent-playlists-list">
                        <!-- Other recent playlists will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-secondary" onclick="BPP.hideDialog('link-playlist-dialog')">Close</button>
            </div>
        </div>
    </div>

    <!-- Manage Collaboration Requests Dialog -->
    <div id="collaboration-requests-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Collaboration Requests</h3>
                <button class="dialog-close" onclick="BPP.hideDialog('collaboration-requests-dialog')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <input type="hidden" id="collaboration-collection-id">
                <div id="collaboration-requests-list" class="collaboration-requests-list">
                    <!-- Requests will be rendered here -->
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-secondary" onclick="BPP.hideDialog('collaboration-requests-dialog')">Close</button>
            </div>
        </div>
    </div>

    <!-- Request Collaborator Access Confirmation Dialog -->
    <div id="request-access-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Request Collaborator Access</h3>
                <button class="dialog-close" onclick="BPP.hideDialog('request-access-dialog')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <input type="hidden" id="request-access-collection-id">
                <p class="text-secondary" style="line-height: 1.6;">
                    Request Collaborator role on this Collection?
                </p>
                <p class="text-secondary" style="line-height: 1.6; margin-top: 12px;">
                    Collaborators can edit Lyrics, Notes and Tempo. The Collection Owner will see this request.
                </p>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-secondary" onclick="BPP.hideDialog('request-access-dialog')">Cancel</button>
                <button id="confirm-request-access-btn" class="btn btn-primary">Send Request</button>
            </div>
        </div>
    </div>

    <!-- Manage Collaborators Dialog -->
    <div id="manage-collaborators-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Manage Collaborators</h3>
                <button class="dialog-close" onclick="BPP.hideDialog('manage-collaborators-dialog')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <input type="hidden" id="manage-collaborators-collection-id">
                <p class="text-secondary" style="line-height: 1.6; margin-bottom: 16px;">
                    Collaborators can edit Lyrics, Notes and Tempo in this Collection.
                </p>
                <div id="collaborators-list" class="collaboration-requests-list">
                    <!-- Collaborators will be rendered here -->
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-secondary" onclick="BPP.hideDialog('manage-collaborators-dialog')">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Lyrics Dialog - Full Screen Split View -->
    <div id="edit-lyrics-dialog" class="dialog-overlay hidden">
        <div class="notes-editor-fullscreen">
            <!-- Header -->
            <div class="notes-editor-header">
                <div class="notes-editor-title">
                    <i class="fa-solid fa-music"></i>
                    <span>Edit Lyrics</span>
                </div>
                <div class="notes-editor-actions">
                    <button class="btn btn-secondary btn-sm" onclick="PlayerManager.cancelLyricsEdit()">
                        <i class="fa-solid fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="PlayerManager.saveLyrics()">
                        <i class="fa-solid fa-save"></i> Save
                    </button>
                </div>
                <div class="notes-editor-hints">
                    <span class="shortcut-hint"><kbd>ESC</kbd> Cancel</span>
                    <span class="shortcut-hint"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> Save</span>
                </div>
            </div>

            <!-- Split View Content -->
            <div class="notes-editor-content" id="lyrics-editor-content">
                <!-- Left Panel: Editable Lyrics with Line Numbers -->
                <div class="notes-editor-panel" id="lyrics-editor-left-panel">
                    <div class="notes-editor-panel-header">
                        <i class="fa-solid fa-edit"></i> Edit Lyrics
                        <div class="lyrics-editor-section-hints">
                            <span class="shortcut-hint"><kbd>Alt</kbd>+<kbd>V</kbd>Verse </span>
                            <span class="shortcut-hint"><kbd>C</kbd>Chorus </span>
                            <span class="shortcut-hint"><kbd>B</kbd>Bridge </span>
                            <span class="shortcut-hint"><kbd>I</kbd>Intro </span>
                            <span class="shortcut-hint"><kbd>O</kbd>Outro </span>
                            <span class="shortcut-hint"><kbd>T</kbd>Tighten</span>
                        </div>
                    </div>
                    <div class="lyrics-editor-wrapper">
                        <div class="lyrics-line-numbers" id="lyrics-line-numbers"></div>
                        <textarea id="lyrics-editor" class="lyrics-textarea-with-numbers" placeholder="Enter lyrics here...

Example:
[Intro]
Some people call me the space cowboy
Yeah, some call me the gangster of love

[Verse 1]
Some people call me Maurice
'Cause I speak of the pompatus of love"></textarea>
                    </div>
                </div>

                <!-- Resizable Divider -->
                <div class="editor-splitter" id="lyrics-editor-splitter">
                    <div class="editor-splitter-handle"></div>
                </div>

                <!-- Right Panel: Read-Only Notes -->
                <div class="notes-editor-lyrics" id="lyrics-editor-right-panel">
                    <div class="notes-editor-panel-header">
                        <i class="fa-solid fa-note-sticky"></i> Practice Notes
                    </div>
                    <div class="notes-editor-lyrics-content" id="lyrics-editor-notes-display">
                        <!-- Notes will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Notes Dialog - Full Screen Split View -->
    <div id="edit-notes-dialog" class="dialog-overlay hidden">
        <div class="notes-editor-fullscreen">
            <!-- Header -->
            <div class="notes-editor-header">
                <div class="notes-editor-title">
                    <i class="fa-solid fa-note-sticky"></i>
                    <span>Edit Practice Notes</span>
                </div>
                <div class="notes-editor-actions">
                    <button class="btn btn-secondary btn-sm" onclick="PlayerManager.cancelNotesEdit()">
                        <i class="fa-solid fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="PlayerManager.saveNotes()">
                        <i class="fa-solid fa-save"></i> Save
                    </button>
                </div>
                <div class="notes-editor-hints">
                    <span class="shortcut-hint"><kbd>ESC</kbd> Cancel</span>
                    <span class="shortcut-hint"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> Save</span>
                </div>
            </div>

            <!-- Split View Content -->
            <div class="notes-editor-content" id="notes-editor-content">
                <!-- Left Panel: Numbered Lyrics -->
                <div class="notes-editor-lyrics" id="notes-editor-left-panel">
                    <div class="notes-editor-panel-header">
                        <i class="fa-solid fa-music"></i> Numbered Lyrics
                    </div>
                    <div class="notes-editor-lyrics-content" id="notes-editor-lyrics-display">
                        <!-- Lyrics will be rendered here -->
                    </div>
                </div>

                <!-- Resizable Divider -->
                <div class="editor-splitter" id="notes-editor-splitter">
                    <div class="editor-splitter-handle"></div>
                </div>

                <!-- Right Panel: Notes Editor -->
                <div class="notes-editor-panel" id="notes-editor-right-panel">
                    <div class="notes-editor-panel-header">
                        <i class="fa-solid fa-edit"></i> Practice Notes
                    </div>
                    <div class="notes-editor-instructions">
                        <div class="notes-editor-instructions-title">Note Format:</div>
                        <div class="notes-editor-format-examples">
                            <code>START: Your note</code>
                            <span class="format-desc">Song beginning</span>
                            <code>5: Your note</code>
                            <span class="format-desc">Single line</span>
                            <code>10-15: Your note</code>
                            <span class="format-desc">Line range</span>
                            <code>END: Your note</code>
                            <span class="format-desc">Song ending</span>
                        </div>
                    </div>
                    <textarea id="notes-editor" class="notes-textarea" placeholder="Add your practice notes here...

Example:
START: Start with drum fill
12: Heavy kick on 1 and 3
45-48: Double time, watch for break
END: Final chorus is acapella"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart BPM Dialog (Tap Trainer + Manual Adjustment) -->
    <div id="bpm-dialog" class="dialog-overlay hidden">
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title"><i class="fa-solid fa-drum"></i> Set BPM</h3>
                <button class="dialog-close" onclick="BPP.hideDialog('bpm-dialog')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <div class="text-center text-sm text-muted mb-md" style="line-height: 1.8;">
                    <div>Tap <kbd>.</kbd> to train the tempo</div>
                    <div><kbd>↑</kbd> <kbd>↓</kbd> to adjust ±0.1 • <kbd>Ctrl</kbd> + <kbd>↑</kbd> <kbd>↓</kbd> to adjust ±1.0</div>
                </div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 12px;">
                    <div id="bpm-metronome-preview" class="bpm-metronome-preview">
                        <i class="fa-solid fa-drum"></i>
                    </div>
                    <div id="bpm-value-display" class="bpm-display-large" style="margin: 0;">--.-</div>
                </div>
                <div id="bpm-tap-count" class="text-center text-sm text-secondary mt-sm">Ready to tap</div>
            </div>
            <div class="dialog-footer">
                <button id="bpm-reset-btn" class="btn btn-secondary" onclick="PlayerManager.resetBpmDialog()">
                    <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
                <button id="bpm-save-btn" class="btn btn-primary" onclick="PlayerManager.saveBpm()">
                    <i class="fa-solid fa-check"></i> Save BPM
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />

    <!-- Common utilities -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script src="{{ url_for('static', filename='js/spotify_player.js') }}"></script>
    <script src="{{ url_for('static', filename='js/authManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/collectionsManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/playlistManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/viewManager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/player.js') }}"></script>

    <script>
        // Firebase configuration from template
        const firebaseConfig = {
            apiKey: "{{ config.FIREBASE_API_KEY }}",
            authDomain: "{{ config.FIREBASE_AUTH_DOMAIN }}",
            projectId: "{{ config.FIREBASE_PROJECT_ID }}"
        };

        // Initialize AuthManager
        AuthManager.init(firebaseConfig);

        // Initialize CollectionsManager
        CollectionsManager.init();

        // Initialize PlaylistManager
        PlaylistManager.init();

        // Callback after successful authentication
        window.onAuthSuccess = function() {
            CollectionsManager.loadCollections();
        };

        // Expose showLinkPlaylistDialog for collection cards to call
        function showLinkPlaylistDialog(collectionId) {
            PlaylistManager.showLinkPlaylistDialog(collectionId);
        }

        // Sign out handler
        document.getElementById('signout-btn')?.addEventListener('click', () => {
            AuthManager.signOut();
        });

        // ESC to close dialogs
        BPP.addEscapeHandler('new-collection-dialog');
        BPP.addEscapeHandler('edit-collection-dialog');
        BPP.addEscapeHandler('delete-collection-dialog');
        BPP.addEscapeHandler('fetch-lyrics-dialog');
        BPP.addEscapeHandler('link-playlist-dialog');
        BPP.addEscapeHandler('request-access-dialog');

        // ============================================================================
        // NOTE: All playlist dialog logic moved to PlaylistManager.js
        // ============================================================================
    </script>
</body>
</html>
